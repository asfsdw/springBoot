<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>uploadList.jsp</title>
	<jsp:include page="/WEB-INF/views/include/bs5.jsp" />
	<script>
		'use strict';
		
		let message = '${message}';
		if(message != "") alert(message);

		// 전체선택
		$(function(){
			$("#checkAll").click(function(){
				if($("#checkAll").prop("checked")) $(".chk").prop("checked", true);
				else $(".chk").prop("checked", false);
			});
		});
		// 선택항목 반전
		$(function(){
			$("#reversekAll").click(function(){
				$("#checkAll").prop("checked",false);
				$(".chk").prop("checked", function(){
					return !$(this).prop("checked");
				});
			});
		});
	  
		// 선택항목 삭제하기(ajax처리하기)
		function selectDelCheck() {
			let ans = confirm("선택된 모든 게시물을 삭제 하시겠습니까?");
			if(!ans) return false;
			let delItems = "";
			for(let i=0; i<myform.chk.length; i++) {
				if(myform.chk[i].checked == true) delItems += myform.chk[i].value + "/";
			}
			if(delItems == "") {
				alert("한개 이상을 선택후 처리하세요.");
				return false;
			}
			
			$.ajax({
				type : "post",
				url  : "/upload/fileSelectDelete",
				data : {delItems : delItems},
				success:function(res) {
					if(res == "1") {
						alert("선택된 파일을 삭제처리 하였습니다.");
						location.reload();
					}
				},
				error  :function() {
					alert("전송오류!!");
				}
			});
		}

		// 고유번호 클릭시 그림 모달로 표시하기
		function imgCheck(file) {
			$(".modal-header .modal-title").html("파일명 : " + file);
			let ext = file.substring(file.lastIndexOf(".")+1).toLowerCase();
			if(ext == 'jpg' || ext == 'gif' || ext == 'png') $(".modal-body #imgSrc").attr("src","/upload/"+file);
			else $(".modal-body #imgSrc").attr("src","/images/noimage.jpg");
			$(".modal-body #fileName").text(file);
		}

		// 화살표클릭시 화면 상단으로 부드럽게 이동하기
		$(window).scroll(function(){
			if($(this).scrollTop() > 100) $("#topBtn").addClass("on");
			else $("#topBtn").removeClass("on");
			
			$("#topBtn").click(function(){
				window.scrollTo({top:0, behavior: "smooth"});
			});
		});
  </script>
	<style>
	h6 {
		position: fixed;
		right: 1rem;
		bottom: -50px;
		transition: 0.7s ease;
	}
	.on {
		opacity: 0.8;
		cursor: pointer;
		bottom: 0;
	}
	</style>
</head>
<body>
	<p><br/></p>
	<div class="container">
		<h2 class="text-center">서버 파일 리스트</h2>
		<hr/>
		<p>서버의 파일 경로 : /webapp/upload/~~~파일명(총 : <b>${fn:length(files)}</b>개)</p>
		<hr/>
		<form name="myform">
			<div class="row mb-2">
				<div class="col">
					<input type="checkbox" id="checkAll" onclick="checkAllCheck()"/>전체선택/해제 &nbsp;&nbsp;
					<input type="checkbox" id="reversekAll" onclick="reverseAllCheck()"/>선택반전 &nbsp;&nbsp;
				</div>
				<div class="col text-end">
					<input type="button" value="선택항목삭제" onclick="selectDelCheck()" class="btn btn-danger btn-sm mr-3"/>
					<input type="button" value="돌아가기" onclick="location.href='/upload/upload'" class="btn btn-warning btn-sm"/>
				</div>
			</div>
			<table class="table table-hover text-center">
				<tr class="table-secondary">
					<th>선택</th><th>번호</th><th>파일명</th><th>그림파일</th>
				</tr>
				<c:if test="${fn:length(files) == 0}">
					<td colspan="4" class="text-center">파일이 존재하지 않습니다.</td>
				</c:if>
				<c:if test="${fn:length(files) != 0}">
					<c:forEach var="file" items="${files}" varStatus="st">
						<tr>
							<td>
								<input type="checkbox" name="chk" class="chk" value="${file}"/>
							</td>
							<td><a href="#" onclick="imgCheck('${file}')" data-bs-toggle="modal" data-bs-target="#myModal">${st.count}</a></td>
							<td><a href="/upload/${file}" download="${file}" title="다운로드" class="text-dark link-primary link-underline-opacity-0 link-underline-opacity-100-hover">${file}</a></td>
							<td>
								<c:set var="ext" value="${fn:substring(file,fn:length(file)-3,fn:length(file))}"/>
								<c:if test="${ext=='jpg' or ext=='gif' or ext=='png'}">
									<a href="/upload/${file}" target="_blank">
										<img src="/upload/${file}" width="100px"/>
									</a>
								</c:if>
								<c:if test="${ext != 'jpg' and ext != 'gif' and ext != 'png'}">
									${file}
								</c:if>
							</td>
						</tr>
					</c:forEach>
				</c:if>
				<tr><td colspan="4" class="m-0 p-0"></td></tr>
			</table>
		</form>
	</div>
<!-- The Modal -->
<div class="modal fade" id="myModal">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header">
				<h4 class="modal-title">Modal Heading</h4>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<!-- Modal body -->
			<div class="modal-body">
				<img id="imgSrc" width="460px"/>
				<div id="fileName"></div><br/>
			</div>
			<!-- Modal footer -->
			<div class="modal-footer">
				<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
<p><br/></p>
<!-- 위로가기 버튼 -->
<h6 id="topBtn" class="text-right mr-3"><img src="/images/top.gif" title="위로이동"/></h6>
</body>

</html>